// Generated by CoffeeScript 1.3.1
(function() {
  var Account, AuthenticationHandler;

  Account = require('./../models/account');

  AuthenticationHandler = (function() {

    AuthenticationHandler.name = 'AuthenticationHandler';

    function AuthenticationHandler(db) {
      this.db = db;
      this.hostExtractor = new RegExp("http://[^/]+");
      this.pathExtractor = new RegExp("[^?]+");
    }

    AuthenticationHandler.prototype.handle = function(handshakeData, callback) {
      var host, key, path, referer,
        _this = this;
      referer = handshakeData.headers.referer;
      host = this.hostExtractor.exec(referer)[0];
      path = this.pathExtractor.exec(referer)[0].replace(host, "");
      key = handshakeData.query.key;
      return Account["with"](this.db).check_by_key_and_connect_host(key, host, {
        on_accepted: function(account) {
          account.connected_host = host;
          account.connected_path = path;
          handshakeData.account = account;
          return callback(null, true);
        },
        on_rejected: function() {
          return callback("Host " + host + " with key " + key + " not authorized!", false);
        }
      });
    };

    return AuthenticationHandler;

  })();

  module.exports = AuthenticationHandler;

}).call(this);
